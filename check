#!/usr/bin/env python
#-*- coding:utf-8 -*-

import os
import sys
import json
import requests
import ansible.runner

class cl:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'

def multi_run():
    runner = ansible.runner.Runner(
            host_list=IPFILE,
            module_name="script",
            module_args=SCRIPT,
            pattern="",
            forks=50,
            become="True",
            timeout=3
    )
    data = runner.run()
    #data = runner.run_async(time_limit)
    return(data)



def write_log(data):
    if LOGPATH:
        with open('LOGPATH', 'a') as f:
            f.write(data)




def process(data):
    if type(data) is dict:
        res = {}
        if data['dark']:
            ret = {}
            print cl.FAIL + "Failure:" + cl.ENDC
            for k,v in data['dark'].items():
                ret[k] = v['msg'].strip()
            res['Failure'] = ret
            print json.dumps(res['Failure'], indent=4).replace('\\r\\n','\n\t\t')
        if data['contacted']:
            ret = {}
            print cl.OKBLUE + "Success:" + cl.ENDC
            for k,v in data['contacted'].items():
                ret[k] = v['stdout'].strip()
            res['Success'] = ret
            print json.dumps(res['Success'], indent=4).replace("\\r\\n","\n\t\t")



if __name__ == '__main__':
    if len(sys.argv) == 3:
        SCRIPT=sys.argv[1]
        IPFILE=sys.argv[2]
        PRIKEY=''
        LOGPATH=''
        data = multi_run()
        process(data)
    else:
        print cl.BOLD + "Usage: ./check.py command.sh ip.list" + cl.ENDC
        sys.exit(1)

